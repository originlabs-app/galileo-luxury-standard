---
phase: 05-token-compliance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - specifications/contracts/token/IToken.sol
  - specifications/contracts/token/IGalileoToken.sol
  - specifications/contracts/token/events/TokenEvents.sol
autonomous: true

must_haves:
  truths:
    - "Token interface extends ERC-3643 IToken for permissioned transfers"
    - "Luxury product metadata accessible via on-chain interface"
    - "CPO certification status queryable for resale eligibility"
    - "Events enable off-chain indexing of token lifecycle"
  artifacts:
    - path: "specifications/contracts/token/IToken.sol"
      provides: "Re-exported ERC-3643 IToken with documentation"
      contains: "import.*@erc3643org/erc-3643"
    - path: "specifications/contracts/token/IGalileoToken.sol"
      provides: "Extended token interface for luxury products"
      exports: ["IGalileoToken"]
      min_lines: 100
    - path: "specifications/contracts/token/events/TokenEvents.sol"
      provides: "Token event definitions"
      exports: ["TokenEvents"]
      min_lines: 80
  key_links:
    - from: "specifications/contracts/token/IGalileoToken.sol"
      to: "@erc3643org/erc-3643/contracts/token/IToken.sol"
      via: "interface inheritance"
      pattern: "interface IGalileoToken is IToken"
    - from: "specifications/contracts/token/IGalileoToken.sol"
      to: "specifications/contracts/identity/IIdentityRegistry.sol"
      via: "identityRegistry() reference"
      pattern: "identityRegistry\\(\\)"
---

<objective>
Create ERC-3643 extended token interfaces for luxury product ownership representation.

Purpose: Enable compliant ownership transfer of luxury goods where one token represents one physical product, with built-in identity verification and compliance checks before any transfer.

Output: Solidity interfaces defining the token contract shape for luxury product tokens, including product metadata, CPO certification status, and lifecycle events.
</objective>

<execution_context>
@/Users/pierrebeunardeau/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pierrebeunardeau/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-token-compliance/05-RESEARCH.md
@specifications/contracts/identity/IIdentityRegistry.sol
@specifications/contracts/identity/IClaimTopicsRegistry.sol
</context>

<tasks>

<task type="auto">
  <name>Task 1: Re-export ERC-3643 IToken with Galileo documentation</name>
  <files>specifications/contracts/token/IToken.sol</files>
  <action>
Create a re-export file that imports and re-exports the standard ERC-3643 IToken interface with comprehensive NatSpec documentation explaining how it's used in the Galileo ecosystem.

The file should:
1. Import `IToken` from `@erc3643org/erc-3643/contracts/token/IToken.sol`
2. Document the key functions from ERC-3643 IToken in NatSpec comments:
   - `setIdentityRegistry(address)` - Bind identity registry
   - `setCompliance(address)` - Bind compliance contract
   - `setOnchainID(address)` - Bind token's ONCHAINID
   - `pause()` / `unpause()` - Global transfer pause
   - `setAddressFrozen(address, bool)` - Address-level freeze
   - `freezePartialTokens(address, uint256)` - Partial balance freeze
   - `recoveryAddress(address, address, address)` - Lost wallet recovery
   - `batchTransfer(address[], uint256[])` - Batch transfers
   - `forcedTransfer(address, address, uint256, bytes)` - Agent recovery transfer
3. Document the inherited ERC-20 functions with security notes
4. Add Galileo-specific usage notes explaining single-supply pattern (totalSupply = 1)

Use SPDX-License-Identifier: Apache-2.0 and pragma solidity ^0.8.20.
  </action>
  <verify>File exists with correct import path and NatSpec documentation for all key functions.</verify>
  <done>IToken re-export provides documented reference to ERC-3643 base interface.</done>
</task>

<task type="auto">
  <name>Task 2: Create IGalileoToken extended interface</name>
  <files>specifications/contracts/token/IGalileoToken.sol</files>
  <action>
Create the extended token interface for Galileo luxury products. This interface extends IToken from ERC-3643 with luxury-specific extensions.

The interface should include:

**Product Metadata (view functions):**
```solidity
function productDID() external view returns (string memory);
function productCategory() external view returns (string memory);
function brandDID() external view returns (string memory);
function productURI() external view returns (string memory);
```

**CPO (Certified Pre-Owned) Status:**
```solidity
function isCPOCertified() external view returns (bool);
function cpoCertificationDate() external view returns (uint256);
function cpoCertifier() external view returns (address);
function cpoCertificationURI() external view returns (string memory);
```

**CPO Management (restricted to authorized certifiers):**
```solidity
function certifyCPO(string calldata certificationURI) external;
function revokeCPO(string calldata reason) external;
```

**Transfer with Reason (for compliance audit trail):**
```solidity
function transferWithReason(
    address to,
    uint256 amount,
    bytes32 reasonCode,
    string calldata reasonDescription
) external returns (bool);
```

**Errors:**
- `NotAuthorizedCertifier` - Caller not authorized to certify CPO
- `AlreadyCPOCertified` - Product already has active CPO certification
- `NotCPOCertified` - Product does not have CPO status
- `InvalidProductDID` - Product DID format invalid

**Events (reference TokenEvents library):**
- CPOCertified, CPORevoked, TransferWithReason

Include comprehensive NatSpec explaining single-supply token pattern (each product is separate token deployment where totalSupply is always 1).
  </action>
  <verify>Interface compiles conceptually (solc check not required for interfaces), has NatSpec for all functions.</verify>
  <done>IGalileoToken interface provides luxury product ownership representation with CPO status.</done>
</task>

<task type="auto">
  <name>Task 3: Create TokenEvents library</name>
  <files>specifications/contracts/token/events/TokenEvents.sol</files>
  <action>
Create a library of token-related events following the pattern established in Phase 4's IdentityEvents.sol.

Organize events by category:

**CPO Events:**
```solidity
event CPOCertified(
    address indexed token,
    address indexed certifier,
    uint256 timestamp,
    string certificationURI
);

event CPORevoked(
    address indexed token,
    address indexed revoker,
    uint256 timestamp,
    string reason
);

event CPOTransferred(
    address indexed token,
    address indexed from,
    address indexed to,
    bool cpoMaintained
);
```

**Transfer Events (extending ERC-3643):**
```solidity
event TransferWithReason(
    address indexed from,
    address indexed to,
    uint256 amount,
    bytes32 indexed reasonCode,
    string reasonDescription
);

event TransferBlocked(
    address indexed from,
    address indexed to,
    uint256 amount,
    string reason
);

event TransferCompleted(
    address indexed token,
    address indexed from,
    address indexed to,
    uint256 complianceModulesChecked
);
```

**Compliance Binding Events:**
```solidity
event ComplianceContractBound(
    address indexed token,
    address indexed compliance,
    uint256 timestamp
);

event IdentityRegistryBound(
    address indexed token,
    address indexed registry,
    uint256 timestamp
);
```

**Recovery Events:**
```solidity
event RecoveryInitiated(
    address indexed lostWallet,
    address indexed newWallet,
    address indexed initiator
);

event RecoveryCompleted(
    address indexed lostWallet,
    address indexed newWallet,
    address indexed investorOnchainID
);
```

**Product Lifecycle Events:**
```solidity
event ProductTokenCreated(
    address indexed token,
    string productDID,
    string brandDID,
    string category
);

event ProductTokenDecommissioned(
    address indexed token,
    string productDID,
    string reason
);
```

Include comprehensive NatSpec for each event explaining when it's emitted and how to use indexed parameters for filtering.
  </action>
  <verify>File exists with all event categories documented.</verify>
  <done>TokenEvents library provides comprehensive event definitions for token lifecycle tracking.</done>
</task>

</tasks>

<verification>
All three files exist and follow established patterns:

```bash
ls -la specifications/contracts/token/
ls -la specifications/contracts/token/events/
```

Check for correct structure:
- IToken.sol re-exports ERC-3643 with documentation
- IGalileoToken.sol extends IToken with luxury extensions
- TokenEvents.sol provides event library

Validate imports reference correct packages:
```bash
grep -r "@erc3643org/erc-3643" specifications/contracts/token/
```
</verification>

<success_criteria>
1. IToken.sol re-exports ERC-3643 IToken with comprehensive Galileo usage documentation
2. IGalileoToken.sol extends IToken with product metadata, CPO status, and transfer with reason
3. TokenEvents.sol provides categorized events for CPO, transfers, compliance binding, recovery, and lifecycle
4. All files use Apache-2.0 license and Solidity ^0.8.20
5. NatSpec documentation covers all public functions and events
</success_criteria>

<output>
After completion, create `.planning/phases/05-token-compliance/05-01-SUMMARY.md`
</output>
