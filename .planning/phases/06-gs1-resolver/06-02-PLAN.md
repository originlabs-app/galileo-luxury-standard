---
phase: 06-gs1-resolver
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - specifications/resolver/resolution-protocol.md
  - specifications/resolver/context-routing.md
  - specifications/resolver/access-control.md
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Resolution algorithm follows GS1 Conformant Resolver Standard 1.2.0"
    - "Context-aware routing delivers role-appropriate views (consumer, brand, regulator, service_center)"
    - "JWT-based authentication gates privileged link types"
    - "Resolution connects GS1 URI to on-chain DID registry and off-chain DPP content"
  artifacts:
    - path: "specifications/resolver/resolution-protocol.md"
      provides: "Complete resolution algorithm specification"
      contains: "GS1-Conformant Resolver"
    - path: "specifications/resolver/context-routing.md"
      provides: "Role-based view selection rules"
      contains: "RequesterRole"
    - path: "specifications/resolver/access-control.md"
      provides: "Authentication and authorization specification"
      contains: "JWT"
  key_links:
    - from: "specifications/resolver/resolution-protocol.md"
      to: "specifications/resolver/digital-link-uri.md"
      via: "URI parsing reference"
      pattern: "parseGS1DigitalLink"
    - from: "specifications/resolver/resolution-protocol.md"
      to: "specifications/identity/DID-METHOD.md"
      via: "DID resolution integration"
      pattern: "did:galileo"
    - from: "specifications/resolver/context-routing.md"
      to: "specifications/resolver/linkset-schema.json"
      via: "Link type filtering"
      pattern: "gs1:pip"
    - from: "specifications/resolver/access-control.md"
      to: "specifications/identity/claim-topics.md"
      via: "Role claims verification"
      pattern: "CLAIM_TOPIC"
---

<objective>
Specify the complete GS1 resolution protocol with context-aware routing and access control for the Galileo resolver.

Purpose: Enable physical products (via QR/NFC) to resolve to appropriate digital content based on who is requesting - consumers see public DPP, brands see full history, regulators see compliance data. This fulfills ESPR requirements for tiered stakeholder access.

Output:
- specifications/resolver/resolution-protocol.md - Complete resolution algorithm
- specifications/resolver/context-routing.md - Role-based view selection
- specifications/resolver/access-control.md - Authentication for privileged views
</objective>

<execution_context>
@/Users/pierrebeunardeau/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pierrebeunardeau/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-gs1-resolver/06-RESEARCH.md
@specifications/resolver/digital-link-uri.md (created in 06-01)
@specifications/resolver/linkset-schema.json (created in 06-01)
@specifications/identity/DID-METHOD.md
@specifications/identity/claim-topics.md
@specifications/architecture/HYBRID-ARCHITECTURE.md
@specifications/schemas/alignment/gs1-integration.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Resolution Protocol Specification</name>
  <files>specifications/resolver/resolution-protocol.md</files>
  <action>
Create the complete GS1-conformant resolution protocol specification:

1. **Overview Section**
   - Purpose: Bridge physical products to digital identities
   - Conformance: GS1-Conformant Resolver Standard 1.2.0 (January 2026)
   - Scope: Resolution of GS1 Digital Link URIs to Galileo DID documents and service endpoints

2. **Resolution Architecture Diagram**
   ```
   [QR/NFC] -> [GS1 URI] -> [Galileo Resolver]
                                    |
                    +---------------+---------------+
                    |               |               |
                    v               v               v
              [Parse URI]    [Detect Context]  [Auth Check]
                    |               |               |
                    +-------+-------+---------------+
                            |
                            v
                    [Build Galileo DID]
                            |
                    +-------+-------+
                    |               |
                    v               v
              [On-Chain]      [Off-Chain]
              (Registry)      (DPP Store)
                    |               |
                    +-------+-------+
                            |
                            v
                    [Build Linkset Response]
                            |
                            v
                    [307 Redirect or Linkset]
   ```

3. **Resolution Algorithm (8 steps)**
   - Step 1: Parse GS1 Digital Link URI (reference digital-link-uri.md)
   - Step 2: Validate GTIN check digit and serial format
   - Step 3: Detect requester context (auth token, linkType, Accept header)
   - Step 4: Build Galileo DID: `did:galileo:01:{GTIN}:21:{Serial}`
   - Step 5: Query on-chain registry for ProductRecord
   - Step 6: Fetch off-chain DID document by contentHash
   - Step 7: Select links based on context and linkType parameter
   - Step 8: Return 307 redirect (single link) or linkset (multiple links)

4. **HTTP Interface Specification**
   - Primary endpoint: `GET /01/{gtin}/21/{serial}`
   - Linkset endpoint: `GET /01/{gtin}/21/{serial}?linkType=linkset`
   - Well-known: `GET /.well-known/gs1resolver` (resolver metadata)
   - Headers: Accept, Accept-Language, Authorization

5. **Response Types**
   - 307 Temporary Redirect: Default for single link match
   - 200 OK with application/linkset+json: When linkType=linkset
   - 400 Bad Request: Invalid URI syntax or GTIN
   - 401 Unauthorized: Privileged linkType without valid auth
   - 404 Not Found: Product not registered
   - 410 Gone: Product deactivated (with deactivation metadata)

6. **Deactivated Product Handling**
   - Return 410 Gone (not 404)
   - Include deactivation reason in response body
   - DID document still resolvable for provenance
   - Metadata: `{ "error": "deactivated", "reason": "{reason}", "did": "{did}" }`

7. **Caching Strategy**
   - Public (consumer) responses: Cache-Control: public, max-age=300
   - Authenticated responses: Cache-Control: private, no-store
   - Link header: `<{uri}?linkType=linkset>; rel="linkset"` always present

8. **Error Response Schema**
   ```json
   {
     "error": "invalidIdentifier|notFound|deactivated|unauthorized",
     "message": "Human-readable description",
     "did": "did:galileo:01:...", // if resolved
     "gs1Uri": "https://id.galileo.luxury/01/..."
   }
   ```

Reference: GS1-Conformant Resolver Standard 1.2.0, 06-RESEARCH.md code examples.
  </action>
  <verify>
Verify document completeness:
- Contains 8-step resolution algorithm
- Includes HTTP response codes (307, 200, 400, 401, 404, 410)
- Specifies deactivated product handling (410 Gone)
- Documents caching strategy for public vs authenticated
- References digital-link-uri.md for URI parsing
- References DID-METHOD.md for DID resolution
  </verify>
  <done>
Resolution protocol specification exists at specifications/resolver/resolution-protocol.md with complete algorithm, HTTP interface, response types, caching strategy, and error handling per GS1 Resolver 1.2.0 standard.
  </done>
</task>

<task type="auto">
  <name>Task 2: Context-Aware Routing Specification</name>
  <files>specifications/resolver/context-routing.md</files>
  <action>
Create the context-aware routing specification for role-based view selection:

1. **Requester Roles (4 primary + anonymous)**
   - `consumer`: Default public view, no authentication required
   - `brand`: Brand administrator, full DPP access
   - `regulator`: Market surveillance authority, compliance view
   - `service_center`: Authorized repair service, technical view
   - (anonymous): Falls back to consumer

2. **Context Detection Priority Order**
   1. JWT role claim (highest priority) - explicit authenticated role
   2. linkType query parameter - specific link type requested
   3. context query parameter - explicit context hint
   4. Accept header - content negotiation
   5. Default: consumer (lowest priority)

3. **Link Type Access Matrix**

   | Link Type | consumer | brand | regulator | service_center |
   |-----------|----------|-------|-----------|----------------|
   | gs1:defaultLink | YES | YES | YES | YES |
   | gs1:pip | YES | YES | YES | YES |
   | gs1:sustainabilityInfo | YES | YES | YES | YES |
   | gs1:instructions | YES | YES | YES | YES |
   | gs1:regulatoryInfo | NO | YES | YES | NO |
   | gs1:traceability | NO | YES | YES | NO |
   | gs1:certificationInfo | YES | YES | YES | YES |
   | galileo:authenticity | YES | YES | YES | YES |
   | galileo:internalDPP | NO | YES | NO | NO |
   | galileo:auditTrail | NO | YES | YES | NO |
   | galileo:serviceInfo | NO | YES | NO | YES |
   | galileo:technicalSpec | NO | YES | NO | YES |
   | galileo:complianceDPP | NO | NO | YES | NO |
   | galileo:espr | NO | NO | YES | NO |

4. **Response Filtering Algorithm**
   ```
   function filterLinksByContext(linkset, role):
     allowed_types = ROLE_LINK_TYPES[role]
     return linkset.filter(link => allowed_types.includes(link.type))
   ```

5. **Default Link Selection**
   - If linkType matches exactly: return that link
   - If linkType=all or linkType=linkset: return filtered linkset
   - If no linkType: select gs1:defaultLink -> redirect

6. **Language Preference Handling**
   - Accept-Language header parsed per HTTP spec
   - Links with matching hreflang preferred
   - Fallback to link without hreflang restriction
   - Example: `Accept-Language: fr-FR, en;q=0.8` prefers French

7. **ESPR Compliance Notes**
   - Consumer view: Product info, sustainability, care instructions
   - Regulator view: Full compliance data, audit trail, ESPR mandatory fields
   - All roles: Authenticity verification always accessible

8. **Conflict Resolution**
   - Authenticated role always wins over query parameters
   - Requesting privileged linkType without auth returns 401
   - Unknown context parameter ignored (falls back to consumer)

Reference existing gs1-integration.md context routing section for consistency.
  </action>
  <verify>
Verify specification:
- Defines all 4 requester roles with descriptions
- Includes complete link type access matrix
- Documents context detection priority order (5 levels)
- Specifies response filtering algorithm
- Covers language preference handling
- Notes ESPR compliance requirements
  </verify>
  <done>
Context routing specification exists at specifications/resolver/context-routing.md with complete role definitions, link type access matrix, context detection priority, response filtering, and ESPR compliance notes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Access Control Specification</name>
  <files>specifications/resolver/access-control.md</files>
  <action>
Create the access control specification for authenticated resolver access:

1. **Authentication Methods**
   - Bearer Token (JWT): Primary method for all privileged access
   - No authentication: Consumer public view only
   - API Key: Rate limiting identification (not authorization)

2. **JWT Token Specification**
   - Algorithm: RS256 or ES256 (asymmetric)
   - Issuer: `https://auth.galileo.luxury`
   - Audience: `https://id.galileo.luxury`
   - Required claims:
     - `sub`: Subject identifier (DID or user ID)
     - `role`: One of `brand`, `regulator`, `service_center`
     - `iat`: Issued at timestamp
     - `exp`: Expiration timestamp (max 1 hour)
   - Optional claims:
     - `brand_did`: Brand DID for brand role (authorization scope)
     - `products`: Array of product DIDs (service_center scope)
     - `jurisdiction`: ISO 3166-1 country code (regulator scope)

3. **Role Claim Verification**
   - `brand` role: Verify brand_did matches product controller
   - `regulator` role: Verify jurisdiction claim if product has geo-restriction
   - `service_center` role: Verify ONCHAINID has SERVICE_CENTER claim topic
   - Cross-reference with identity registry (claim-topics.md)

4. **Authorization Flow**
   ```
   1. Extract Bearer token from Authorization header
   2. Validate JWT signature against issuer JWKS
   3. Check exp claim (reject if expired)
   4. Check aud claim (must include resolver)
   5. Extract role claim
   6. For brand: verify brand_did is product controller
   7. For service_center: verify ONCHAINID has valid claim
   8. For regulator: accept (pre-verified at token issuance)
   9. Return authorized context
   ```

5. **JWKS Endpoint**
   - URL: `https://auth.galileo.luxury/.well-known/jwks.json`
   - Key rotation: Cached for 24 hours, invalidate on 401
   - Multiple keys supported (kid header for selection)

6. **Rate Limiting by Authentication**
   - Anonymous: 100 requests/minute per IP
   - API Key: 1,000 requests/minute
   - Authenticated (JWT): 10,000 requests/minute
   - Brand admin: 50,000 requests/minute (bulk operations)

7. **Error Responses**
   - 401 Unauthorized: Missing or invalid token
     - `WWW-Authenticate: Bearer realm="galileo", error="invalid_token"`
   - 403 Forbidden: Valid token but insufficient permissions
     - Body: `{ "error": "forbidden", "required_role": "brand", "your_role": "consumer" }`

8. **Security Considerations**
   - Tokens transmitted over HTTPS only
   - Short-lived tokens (1 hour max)
   - No token storage on resolver (stateless validation)
   - Signature verification required (never accept unsigned)
   - Clock skew tolerance: 30 seconds

9. **ONCHAINID Integration**
   - Service center authorization verified via on-chain claim
   - Claim topic: SERVICE_CENTER (from claim-topics.md)
   - Claim not revoked and not expired
   - Query: `identityRegistry.hasValidClaim(identity, SERVICE_CENTER_TOPIC)`

Reference: Phase 4 identity specifications for ONCHAINID claim verification.
  </action>
  <verify>
Verify specification:
- Defines JWT token structure with required claims
- Documents authorization flow (9 steps)
- Specifies JWKS endpoint for key retrieval
- Includes rate limiting tiers
- Documents 401/403 error responses
- References ONCHAINID for service_center verification
  </verify>
  <done>
Access control specification exists at specifications/resolver/access-control.md with JWT token structure, authorization flow, JWKS configuration, rate limiting, error responses, and ONCHAINID integration for claim-based authorization.
  </done>
</task>

</tasks>

<verification>
Phase 6 Plan 02 verification:

1. **Resolution Protocol Completeness**
   - [ ] 8-step resolution algorithm documented
   - [ ] HTTP interface (endpoints, headers, responses) specified
   - [ ] Deactivated product handling (410 Gone) included
   - [ ] Caching strategy for public vs authenticated
   - [ ] References Plan 01 artifacts (digital-link-uri.md, linkset-schema.json)

2. **Context Routing Completeness**
   - [ ] All 4 roles defined (consumer, brand, regulator, service_center)
   - [ ] Link type access matrix covers all GS1 and Galileo types
   - [ ] Context detection priority order (5 levels)
   - [ ] Response filtering algorithm specified
   - [ ] ESPR compliance requirements noted

3. **Access Control Completeness**
   - [ ] JWT token structure with required claims
   - [ ] Authorization flow for each role type
   - [ ] JWKS endpoint and key rotation
   - [ ] Rate limiting by authentication level
   - [ ] ONCHAINID integration for service_center

4. **Integration**
   - [ ] All three documents cross-reference each other
   - [ ] References DID-METHOD.md, claim-topics.md
   - [ ] Consistent with gs1-integration.md
</verification>

<success_criteria>
- Resolution protocol follows GS1 Conformant Resolver 1.2.0 standard
- Context-aware routing delivers appropriate views for all 4 roles
- Access control enables JWT-based privileged access
- All specifications integrate with Phase 4 identity infrastructure
- Physical product identifiers can resolve to on-chain and off-chain data
</success_criteria>

<output>
After completion, create `.planning/phases/06-gs1-resolver/06-02-SUMMARY.md`
</output>
