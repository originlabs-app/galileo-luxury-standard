---
phase: 07-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - specifications/infrastructure/data-retention.md
  - specifications/infrastructure/hybrid-sync.md
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Data retention policies align GDPR erasure rights with AML 5-year retention requirements"
    - "Retention schedules defined per data category (AML/KYC, transactions, audit, PII, product)"
    - "Erasure workflow checks retention obligations before deletion per GDPR Art. 17(3)(b)"
    - "Hybrid storage sync follows off-chain-first event sourcing with on-chain hash anchoring"
  artifacts:
    - path: "specifications/infrastructure/data-retention.md"
      provides: "Complete data retention policies with GDPR/AML conflict resolution"
      contains: "GDPR Art. 17(3)(b)"
    - path: "specifications/infrastructure/hybrid-sync.md"
      provides: "On-chain/off-chain synchronization protocol specification"
      contains: "event sourcing"
  key_links:
    - from: "specifications/infrastructure/data-retention.md"
      to: "specifications/architecture/HYBRID-ARCHITECTURE.md"
      via: "CRAB model for erasure"
      pattern: "CRAB"
    - from: "specifications/infrastructure/hybrid-sync.md"
      to: "specifications/architecture/HYBRID-ARCHITECTURE.md"
      via: "Event sourcing protocol extension"
      pattern: "off-chain first"
    - from: "specifications/infrastructure/data-retention.md"
      to: "specifications/infrastructure/audit-trail.md"
      via: "Audit trail retention alignment"
      pattern: "7 years"
---

<objective>
Create the data retention policies specification and hybrid storage synchronization protocol for the Galileo ecosystem.

Purpose: Define legally compliant data retention that balances GDPR deletion rights with AML/MiCA retention requirements, and formalize the on-chain/off-chain synchronization protocol for maintaining data consistency across the hybrid architecture.

Output:
- specifications/infrastructure/data-retention.md - Data retention policies and erasure workflows
- specifications/infrastructure/hybrid-sync.md - On-chain/off-chain synchronization protocol
</objective>

<execution_context>
@/Users/pierrebeunardeau/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pierrebeunardeau/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-infrastructure/07-RESEARCH.md
@specifications/architecture/HYBRID-ARCHITECTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Data Retention Policies Specification</name>
  <files>specifications/infrastructure/data-retention.md</files>
  <action>
Create comprehensive data retention policies specification with:

1. **Overview and Purpose**
   - Specification ID: GSPEC-INFRA-003
   - Balance GDPR right to erasure with AML/MiCA retention requirements
   - Reference to HYBRID-ARCHITECTURE.md CRAB model
   - Legal basis per data category

2. **Regulatory Framework**

   Document applicable regulations:
   - GDPR Article 17: Right to erasure
   - GDPR Article 17(3)(b): Legal obligation exception
   - 5AMLD Article 40: 5-year AML retention
   - MiCA/TFR 2023/1113: Transaction record retention
   - SOX: Financial audit trail requirements

3. **Data Classification Matrix**

   Define retention per data category:

   | Data Category | Min Retention | Max Retention | Legal Basis | Erasure on Request |
   |---------------|---------------|---------------|-------------|-------------------|
   | AML/KYC records | 5 years | 7 years | 5AMLD Art. 40 | No (Art. 17(3)(b)) |
   | Transaction logs | 5 years | 7 years | MiCA TFR | No (Art. 17(3)(b)) |
   | Audit trail | 7 years | 10 years | SOX/Regulatory | No (Art. 17(3)(b)) |
   | Customer PII | None | Purpose expiry | GDPR Art. 6(1)(b) | Yes (with checks) |
   | Product data | Indefinite | Indefinite | Legitimate interest | No (not personal) |
   | Encryption keys | Until erasure | Until erasure | CRAB model | On valid request |

4. **GDPR-AML Conflict Resolution**

   Document resolution rules:

   | Scenario | GDPR Requirement | AML Requirement | Resolution |
   |----------|------------------|-----------------|------------|
   | Erasure during retention | Delete | Retain 5 years | Refuse per Art. 17(3)(b) |
   | Post-retention erasure | Delete 30 days | No longer applies | Honor request |
   | Anonymization request | Reduce to non-personal | May need original | Pseudonymize |

   Legal basis: GDPR Article 17(3)(b) - "compliance with a legal obligation"

5. **Retention Period Calculation**

   Define trigger events and calculations:
   - AML records: 5 years from end of business relationship
   - Transaction logs: 5 years from transaction date
   - Audit trail: 7 years from entry creation
   - Customer PII: Until purpose fulfilled + grace period

   Include timezone handling (UTC) and leap year considerations.

6. **Erasure Request Workflow**

   Define step-by-step workflow:

   ```
   1. RECEIVE REQUEST
      - Validate requester identity (data subject)
      - Log request receipt (audit trail)
      - Start 30-day timer (GDPR deadline)

   2. RETENTION CHECK
      - Query retention periods for all subject's data
      - Check for active legal holds
      - Identify data under AML retention

   3. DECISION
      - If AML retention applies: REFUSE with Art. 17(3)(b) basis
      - If legal hold active: REFUSE until hold released
      - If no blockers: PROCEED to erasure

   4. ERASURE (if approved)
      - Delete off-chain content
      - Destroy encryption keys (CRAB)
      - Log erasure completion
      - Notify data subject

   5. REFUSAL DOCUMENTATION (if refused)
      - Document legal basis
      - Notify data subject with explanation
      - Log refusal in audit trail
   ```

7. **Legal Hold Support**

   - Legal hold creation: Prevent expiry during litigation
   - Hold scope: All data or specific categories
   - Hold release: Manual with audit logging
   - Notification: Inform data retention system

8. **Retention Monitoring**

   Define monitoring requirements:
   - Daily scan for expiring records
   - 30-day advance warning
   - Automatic archive on expiry (not delete)
   - Manual review before final deletion

9. **Data Subject Rights Implementation**

   Map GDPR rights to implementation:
   - Right to access: Query all subject data
   - Right to rectification: Update off-chain, new hash on-chain
   - Right to erasure: Workflow per Section 6
   - Right to portability: JSON export format
   - Right to restriction: Freeze processing flag

Format: Follow existing specification style (version header, table of contents, decision trees).
Reference: 07-RESEARCH.md for retention policy patterns.
  </action>
  <verify>
Verify the document:
- Contains data classification matrix with all categories
- Documents GDPR-AML conflict resolution
- Includes erasure request workflow with decision tree
- References GDPR Art. 17(3)(b) as legal basis
- Includes legal hold support
- Specifies 5-year AML and 7-year audit retention
  </verify>
  <done>
Data retention specification exists at specifications/infrastructure/data-retention.md with complete classification matrix, GDPR-AML conflict resolution, erasure workflow, and retention monitoring requirements.
  </done>
</task>

<task type="auto">
  <name>Task 2: Hybrid Storage Sync Protocol Specification</name>
  <files>specifications/infrastructure/hybrid-sync.md</files>
  <action>
Create comprehensive hybrid storage synchronization protocol specification with:

1. **Overview and Purpose**
   - Specification ID: GSPEC-INFRA-004
   - Formalize event sourcing protocol from HYBRID-ARCHITECTURE.md
   - Define consistency guarantees and failure handling
   - Off-chain-first write pattern with on-chain anchoring

2. **Event Sourcing Protocol**

   Formalize the 6-step event flow from HYBRID-ARCHITECTURE.md:

   ```
   1. ACTION OCCURS
      - Product lifecycle event triggered
      - Generate canonical event representation

   2. OFF-CHAIN FIRST (CRITICAL)
      - Store complete event in off-chain store
      - Generate eventId (UUID v7)
      - Compute contentHash (SHA-256 of canonical JSON)
      - MUST complete before Step 3

   3. WAIT FOR CONFIRMATION
      - Verify off-chain write acknowledged
      - Retry on failure (exponential backoff)
      - DO NOT proceed if off-chain fails

   4. ON-CHAIN ANCHOR
      - Emit event: (productDID, eventType, contentHash, timestamp)
      - Wait for transaction confirmation (12 blocks)
      - Record transactionHash

   5. INDEX UPDATE
      - Link contentHash -> offChainEventId
      - Enable bidirectional lookup
      - Update product event stream

   6. PERIODIC MERKLE ANCHOR (optional)
      - Batch events into Merkle tree (daily)
      - Anchor root hash on-chain
      - Enable compact proof generation
   ```

3. **Consistency Model**

   Define consistency guarantees:
   - Strong consistency for writes (off-chain before on-chain)
   - Eventual consistency for reads (indexer may lag)
   - Maximum read lag: 5 seconds typical, 60 seconds maximum
   - Conflict resolution: On-chain timestamp wins

4. **Write Protocol**

   Detailed write specification:

   ```typescript
   interface WriteProtocol {
     // Step 1: Prepare event
     prepareEvent(event: LifecycleEvent): CanonicalEvent;

     // Step 2: Off-chain write (MUST succeed first)
     writeOffChain(event: CanonicalEvent): Promise<OffChainResult>;

     // Step 3: On-chain anchor
     anchorOnChain(
       productDID: string,
       eventType: EventType,
       contentHash: bytes32
     ): Promise<OnChainResult>;

     // Step 4: Index update
     updateIndex(offChainId: string, onChainTx: string): Promise<void>;
   }
   ```

   Include retry logic, idempotency, and timeout handling.

5. **Read Protocol**

   Define read patterns:
   - Primary: Query off-chain by productDID
   - Verification: Compare contentHash with on-chain
   - Fallback: Reconstruct from on-chain events if off-chain unavailable

   ```typescript
   interface ReadProtocol {
     // Primary read path
     readProduct(productDID: string): Promise<ProductData>;

     // Verify integrity
     verifyConsistency(productDID: string): Promise<ConsistencyResult>;

     // Fallback (on-chain events only)
     reconstructFromChain(productDID: string): Promise<PartialProductData>;
   }
   ```

6. **Consistency States**

   Define possible consistency states:

   | State | Definition | Action |
   |-------|------------|--------|
   | VERIFIED | Off-chain hash matches on-chain | Normal operation |
   | PENDING | Off-chain exists, not yet anchored | Wait for anchor |
   | MISMATCH | Hashes don't match | Quarantine, investigate |
   | ORPHANED | On-chain exists, off-chain deleted (CRAB) | Expected after erasure |
   | MISSING | On-chain reference, off-chain not found | Attempt recovery |

7. **Failure Handling**

   Comprehensive failure scenarios:

   | Failure | Detection | Recovery | Data State |
   |---------|-----------|----------|------------|
   | Off-chain write fails | HTTP error/timeout | Retry with backoff, no on-chain | Safe, event not recorded |
   | On-chain fails | Tx revert/gas error | Retry on-chain, off-chain safe | Eventually consistent |
   | Hash mismatch | Verification check | Quarantine, manual review | Preserved for audit |
   | Indexer lag | Stale query results | Accept eventual consistency | Temporarily stale |
   | Network partition | Off-chain unreachable | Queue on-chain, replay later | Temporary inconsistency |

8. **Reconciliation Protocol**

   Define periodic reconciliation:

   ```
   Daily Reconciliation Job:
   1. Query all on-chain events since last reconciliation
   2. For each event, verify off-chain content exists
   3. Verify contentHash matches
   4. Report discrepancies: MISMATCH, MISSING
   5. Quarantine problematic records
   6. Log reconciliation results (audit trail)
   ```

9. **Canonical JSON Specification**

   Formalize JSON canonicalization (RFC 8785 JCS):
   - Keys sorted alphabetically (recursive)
   - No trailing commas
   - No whitespace between elements
   - UTF-8 NFC normalization
   - Dates in ISO 8601 format (UTC)
   - Numbers as JSON numbers (not strings)

   Include example of canonical vs non-canonical JSON.

10. **Performance Targets**

    | Operation | Target Latency | SLA |
    |-----------|---------------|-----|
    | Off-chain write | < 100ms | 99.9% |
    | On-chain anchor | < 15 seconds | Block time |
    | Index update | < 5 seconds | 99% |
    | Full sync | < 500ms | 95% |
    | Verification | < 200ms | 99% |

11. **Monitoring and Alerting**

    Define monitoring requirements:
    - Off-chain write failure rate
    - On-chain anchor failure rate
    - Indexer lag (seconds)
    - Consistency state distribution
    - Reconciliation discrepancy count

Format: Follow existing specification style with sequence diagrams.
Reference: HYBRID-ARCHITECTURE.md Section 5 (Event Sourcing Protocol).
  </action>
  <verify>
Verify the document:
- Contains complete 6-step event sourcing protocol
- Defines all consistency states (VERIFIED, PENDING, MISMATCH, ORPHANED, MISSING)
- Includes write and read protocol interfaces
- Documents failure handling for all scenarios
- Specifies reconciliation protocol
- References HYBRID-ARCHITECTURE.md and extends it
  </verify>
  <done>
Hybrid sync specification exists at specifications/infrastructure/hybrid-sync.md with complete event sourcing protocol, consistency model, failure handling, and reconciliation procedures.
  </done>
</task>

</tasks>

<verification>
Phase 7 Plan 02 verification:

1. **Data Retention Completeness**
   - [ ] Data classification matrix with 6 categories
   - [ ] GDPR-AML conflict resolution documented
   - [ ] Erasure request workflow with decision tree
   - [ ] Legal hold support specified
   - [ ] Retention periods: 5y AML, 7y audit

2. **Hybrid Sync Completeness**
   - [ ] 6-step event sourcing protocol formalized
   - [ ] Consistency states defined (5 states)
   - [ ] Write and read protocol interfaces
   - [ ] Failure handling for all scenarios
   - [ ] Reconciliation protocol documented

3. **Cross-Reference Integrity**
   - [ ] Data retention references HYBRID-ARCHITECTURE.md CRAB model
   - [ ] Hybrid sync extends HYBRID-ARCHITECTURE.md Section 5
   - [ ] Consistent terminology across specifications
</verification>

<success_criteria>
- Data retention policies complete with GDPR/AML alignment
- Hybrid sync protocol formalizes event sourcing with consistency guarantees
- Both specifications integrate with existing HYBRID-ARCHITECTURE.md
- Ready to support INFRA-04 (Retention) and INFRA-05 (Hybrid Storage) requirements
</success_criteria>

<output>
After completion, create `.planning/phases/07-infrastructure/07-02-SUMMARY.md`
</output>
