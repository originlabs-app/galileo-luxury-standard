---
phase: 04-identity-infrastructure
plan: 04-01
title: Identity Registry Interfaces
wave: 1
depends_on: []
estimated_files: 3
---

# Plan 04-01: Identity Registry Interfaces

## Summary

This plan delivers the Solidity interface specifications for the Identity Registry layer of Galileo's ERC-3643 compliant identity infrastructure. The Identity Registry is the core verification mechanism that checks participant eligibility before any token transfer. Building on T-REX v4.1.3 interfaces, these specifications extend ERC-3643 patterns with Galileo-specific requirements: cross-brand consent verification (GDPR Article 6 compliance), batch verification for efficiency, and hybrid consortium/brand registry architecture. The interfaces define the contract that brand-deployed registries must implement to participate in the Galileo ecosystem.

## Requirements Covered

- **IDENT-01**: Interfaces Solidity pour Identity Registry (ERC-3643) - Extended interfaces for participant verification with consent support
- **IDENT-02**: Interfaces Solidity pour Identity Registry Storage - Shared storage interface enabling multi-registry binding

## Artifacts

### Core Interfaces
- `specifications/contracts/identity/IIdentityRegistry.sol` - Extended ERC-3643 IIdentityRegistry with Galileo consent verification and batch operations
- `specifications/contracts/identity/IIdentityRegistryStorage.sol` - Shared storage interface for multi-registry architecture

### Event Definitions
- `specifications/contracts/identity/events/IdentityEvents.sol` - Comprehensive event library for identity operations, consent management, and audit trail

## Must-Haves

1. **IIdentityRegistry.sol** extends `@erc3643org/erc-3643` IIdentityRegistry interface (not replaces)
2. **IIdentityRegistry.sol** includes `isVerifiedWithConsent(address, uint256, address)` for cross-brand verification
3. **IIdentityRegistry.sol** includes `batchVerify(address, uint256[])` for efficient multi-topic checks
4. **IIdentityRegistryStorage.sol** supports binding multiple Identity Registries (consortium + brand model)
5. **IdentityEvents.sol** defines events for: registration, deletion, update, consent grant/revoke, verification
6. **All interfaces** use Solidity ^0.8.20 for compatibility with ERC-3643 v4.1.3
7. **All interfaces** include NatSpec documentation for every function and event

## Approach

### Task 1: IIdentityRegistry Extended Interface

Create the extended Identity Registry interface that builds on ERC-3643:

**File:** `specifications/contracts/identity/IIdentityRegistry.sol`

**Standard ERC-3643 functions (inherited):**
- `registerIdentity(address _userAddress, IIdentity _identity, uint16 _country)`
- `deleteIdentity(address _userAddress)`
- `updateIdentity(address _userAddress, IIdentity _identity)`
- `updateCountry(address _userAddress, uint16 _country)`
- `contains(address _userAddress) returns (bool)`
- `isVerified(address _userAddress) returns (bool)`
- `identity(address _userAddress) returns (IIdentity)`
- `investorCountry(address _userAddress) returns (uint16)`

**Galileo Extensions:**

```solidity
interface IGalileoIdentityRegistry is IIdentityRegistry {
    /// @notice Verify with cross-brand consent check
    /// @param _userAddress User's wallet address
    /// @param _claimTopic Required claim topic (bytes32 keccak256 of namespace)
    /// @param _requestingBrand Address of brand's Identity Registry requesting verification
    /// @return True if user has valid claim AND consent is granted to requesting brand
    function isVerifiedWithConsent(
        address _userAddress,
        uint256 _claimTopic,
        address _requestingBrand
    ) external view returns (bool);

    /// @notice Batch verification for multiple claim topics
    /// @param _userAddress User's wallet address
    /// @param _claimTopics Array of required claim topics
    /// @return results Array of verification results (parallel to input array)
    function batchVerify(
        address _userAddress,
        uint256[] calldata _claimTopics
    ) external view returns (bool[] memory results);

    /// @notice Check if registry is part of Galileo consortium
    /// @return True if registered with consortium TIR/CTR
    function isConsortiumMember() external view returns (bool);

    /// @notice Get the consortium registries this registry is bound to
    /// @return tir Address of Trusted Issuers Registry
    /// @return ctr Address of Claim Topics Registry
    function getConsortiumRegistries() external view returns (address tir, address ctr);
}
```

**Implementation notes:**
- Import path: `@erc3643org/erc-3643/contracts/registry/interface/IIdentityRegistry.sol`
- Country codes use uint16 per ERC-3643 (ISO 3166-1 numeric)
- Claim topics use uint256 (keccak256 of galileo namespace strings)
- Consent verification queries user's ONCHAINID `hasConsent()` method

### Task 2: IIdentityRegistryStorage Interface

Create the shared storage interface supporting federated registries:

**File:** `specifications/contracts/identity/IIdentityRegistryStorage.sol`

**Standard ERC-3643 functions (inherited):**
- `addIdentityToStorage(address _userAddress, IIdentity _identity, uint16 _country)`
- `modifyStoredIdentity(address _userAddress, IIdentity _identity)`
- `modifyStoredInvestorCountry(address _userAddress, uint16 _country)`
- `removeIdentityFromStorage(address _userAddress)`
- `bindIdentityRegistry(address _identityRegistry)`
- `unbindIdentityRegistry(address _identityRegistry)`
- `linkedIdentityRegistries() returns (address[])`
- `storedIdentity(address _userAddress) returns (IIdentity)`
- `storedInvestorCountry(address _userAddress) returns (uint16)`

**Galileo Extensions:**

```solidity
interface IGalileoIdentityRegistryStorage is IIdentityRegistryStorage {
    /// @notice Bind a brand registry with consortium verification
    /// @param _identityRegistry Brand's Identity Registry address
    /// @param _brandDID Brand's DID for audit trail
    /// @dev Only callable by consortium admin or brand with valid membership claim
    function bindBrandRegistry(
        address _identityRegistry,
        string calldata _brandDID
    ) external;

    /// @notice Check if a registry is bound to this storage
    /// @param _identityRegistry Registry address to check
    /// @return True if registry is bound
    function isRegistryBound(address _identityRegistry) external view returns (bool);

    /// @notice Get all brand registries bound to this storage
    /// @return Array of bound registry addresses
    function getBoundRegistries() external view returns (address[] memory);

    /// @notice Get brand DID associated with a registry
    /// @param _identityRegistry Registry address
    /// @return Brand DID string
    function getRegistryBrandDID(address _identityRegistry) external view returns (string memory);
}
```

**Architecture note:**
- One shared storage per consortium
- Multiple brand registries bind to same storage
- Storage holds identity mappings; registries enforce verification rules
- Brand registry binding requires valid consortium membership claim

### Task 3: Identity Events Library

Create comprehensive event definitions for audit trail:

**File:** `specifications/contracts/identity/events/IdentityEvents.sol`

```solidity
// SPDX-License-Identifier: Apache-2.0
pragma solidity ^0.8.20;

/// @title Galileo Identity Events
/// @notice Event definitions for identity registry operations
/// @dev Extends ERC-3643 events with Galileo-specific audit events
library IdentityEvents {
    // === Registration Events ===

    /// @notice Emitted when identity is registered
    /// @param investorAddress User's wallet address
    /// @param identity ONCHAINID contract address
    /// @param country ISO 3166-1 numeric country code
    /// @param registrar Address that performed registration
    event IdentityRegistered(
        address indexed investorAddress,
        address indexed identity,
        uint16 country,
        address indexed registrar
    );

    /// @notice Emitted when identity is removed
    event IdentityRemoved(
        address indexed investorAddress,
        address indexed identity,
        address indexed remover
    );

    /// @notice Emitted when identity contract is updated
    event IdentityUpdated(
        address indexed investorAddress,
        address indexed oldIdentity,
        address indexed newIdentity
    );

    /// @notice Emitted when country is updated
    event CountryUpdated(
        address indexed investorAddress,
        uint16 oldCountry,
        uint16 newCountry
    );

    // === Consent Events (Galileo-specific) ===

    /// @notice Emitted when user grants consent to a brand
    /// @param userAddress User's wallet address
    /// @param brand Brand's Identity Registry address
    /// @param claimTopic Claim topic consent is granted for
    /// @param expiry Timestamp when consent expires (0 = never)
    event ConsentGranted(
        address indexed userAddress,
        address indexed brand,
        uint256 indexed claimTopic,
        uint256 expiry
    );

    /// @notice Emitted when user revokes consent
    event ConsentRevoked(
        address indexed userAddress,
        address indexed brand,
        uint256 indexed claimTopic
    );

    /// @notice Emitted when consent-based verification occurs
    event ConsentVerified(
        address indexed userAddress,
        address indexed requestingBrand,
        uint256 indexed claimTopic,
        bool result
    );

    // === Registry Binding Events ===

    /// @notice Emitted when a registry binds to storage
    event RegistryBound(
        address indexed identityRegistry,
        address indexed storage_,
        string brandDID
    );

    /// @notice Emitted when a registry unbinds from storage
    event RegistryUnbound(
        address indexed identityRegistry,
        address indexed storage_
    );

    // === Verification Events ===

    /// @notice Emitted when batch verification is performed
    event BatchVerificationPerformed(
        address indexed userAddress,
        address indexed verifier,
        uint256 topicsChecked,
        uint256 topicsPassed
    );
}
```

## Dependencies

### External Standards
- **ERC-3643 v4.1.3**: `@erc3643org/erc-3643` - Base interfaces for IIdentityRegistry, IIdentityRegistryStorage
- **ONCHAINID**: IIdentity interface for identity contract references
- **Solidity ^0.8.20**: Language version required by ERC-3643 contracts

### Prior Phase Outputs
- **Phase 2 (02-01-PLAN)**: Hybrid architecture decision - on-chain for verification, off-chain for content
- **Phase 2 (02-03-PLAN)**: did:galileo method - brand DIDs follow this format

### Phase 4 Context
- **04-CONTEXT.md**: Hybrid consortium + brand registry architecture decision
- **04-CONTEXT.md**: ONCHAINID (ERC-734/735) as native identity standard
- **04-CONTEXT.md**: Explicit consent for cross-brand claim sharing (GDPR Article 6)

## Out of Scope

- Implementation code (interfaces only)
- Trusted Issuers Registry (covered in 04-02-PLAN)
- Claim Topics Registry (covered in 04-02-PLAN)
- ONCHAINID specification (covered in 04-03-PLAN)
- W3C Verifiable Credentials (covered in 04-03-PLAN)
- Factory deployment patterns (implementation detail)
- Upgrade proxy patterns (implementation detail)
- Gas optimization (implementation concern)
