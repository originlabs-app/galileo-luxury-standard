---
phase: 02-architecture-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - specifications/architecture/HYBRID-ARCHITECTURE.md
autonomous: true

must_haves:
  truths:
    - "Architecture document defines exactly what data goes on-chain vs off-chain"
    - "Personal data is explicitly prohibited from on-chain storage (EDPB 02/2025 compliant)"
    - "Event sourcing pattern synchronizes on-chain events with off-chain content"
    - "CRAB model enables right-to-erasure via key destruction"
  artifacts:
    - path: "specifications/architecture/HYBRID-ARCHITECTURE.md"
      provides: "Complete hybrid architecture specification"
      contains: "Data Classification Matrix"
    - path: "specifications/architecture/HYBRID-ARCHITECTURE.md"
      provides: "EDPB compliance checklist"
      contains: "EDPB Guidelines 02/2025"
    - path: "specifications/architecture/HYBRID-ARCHITECTURE.md"
      provides: "Event sourcing protocol"
      contains: "Source of Truth Hierarchy"
  key_links:
    - from: "specifications/architecture/HYBRID-ARCHITECTURE.md"
      to: "EDPB Guidelines 02/2025"
      via: "compliance reference"
      pattern: "EDPB.*02/2025"
    - from: "specifications/architecture/HYBRID-ARCHITECTURE.md"
      to: "ERC-3643 ONCHAINID"
      via: "identity pattern reference"
      pattern: "ONCHAINID|ERC-3643"
---

<objective>
Create the hybrid on-chain/off-chain architecture specification for GDPR-compliant blockchain operations.

Purpose: Define the foundational data boundaries that enable the Galileo Luxury Standard to operate on blockchain while maintaining full GDPR compliance. This specification ensures no personal data is ever stored on-chain, following EDPB Guidelines 02/2025 (FOUND-01).

Output: `specifications/architecture/HYBRID-ARCHITECTURE.md` containing data classification matrix, EDPB compliance checklist, event sourcing protocol, and component interaction diagrams.
</objective>

<execution_context>
@/Users/pierrebeunardeau/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pierrebeunardeau/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-architecture-foundation/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Data Boundary Specification with EDPB Compliance</name>
  <files>specifications/architecture/HYBRID-ARCHITECTURE.md</files>
  <action>
Create `specifications/architecture/` directory.

Create `specifications/architecture/HYBRID-ARCHITECTURE.md` with the following sections:

## 1. Overview
- Purpose: GDPR-compliant blockchain architecture for luxury product traceability
- Regulatory basis: EDPB Guidelines 02/2025 on blockchain and personal data
- Core principle: "When in doubt, store off-chain"

## 2. Data Classification Matrix

Create a table defining what goes where:

**ON-CHAIN (Immutable):**
- Product DID (hash-based reference only)
- Content hash (SHA-256 of off-chain content)
- Ownership address (blockchain address, not personal identity)
- Compliance attestation result (boolean only, not the evidence)
- Timestamp (block timestamp)
- Claim topic IDs (reference only, not claim content)
- Event type enum (created, transferred, serviced, decommissioned)

**OFF-CHAIN (Erasable):**
- Full DPP content (materials, sustainability, origin details)
- Lifecycle event details (repair notes, service records)
- Customer purchase data (name, address, preferences)
- Artisan/creator PII (craftsperson attribution)
- KYC/KYB documents and evidence
- Scanned certificates and images
- Claim content (W3C Verifiable Credentials)

**EXPLICITLY PROHIBITED ON-CHAIN:**
- Natural person names
- Physical addresses
- Email addresses
- Phone numbers
- Photographs of individuals
- Any data that identifies or could identify a natural person
- Encrypted PII (still personal data under GDPR)
- Hashed PII (still personal data under GDPR)

## 3. EDPB 02/2025 Compliance Checklist

Create a checklist based on EDPB guidance:
- [ ] No personal data stored directly on blockchain
- [ ] DPIA completed for any blockchain processing
- [ ] "Technical impossibility" not used as compliance defense
- [ ] Data subject rights implementable (access, rectification, erasure)
- [ ] Legal basis documented for each data processing operation
- [ ] Controller/processor relationships defined for node operators
- [ ] Off-chain storage supports deletion within GDPR timelines
- [ ] Hash-to-content mapping enables orphaning for erasure

Include key EDPB quotes:
- "The EDPB recommends not storing personal data directly in a blockchain at all"
- "Technical impossibility is not a justification for disregarding the rights of data subjects"
- "Encrypted or hashed data remains personal data under GDPR"

## 4. CRAB Model (Create-Read-Append-Burn)

Document the erasure mechanism:
1. Create: PII stored off-chain, reference (hash) stored on-chain
2. Read: Normal access via hash lookup
3. Append: New events add new hashes, no mutation
4. Burn: Delete off-chain content + destroy encryption key

Diagram the erasure flow:
```
Erasure Request Flow:
1. Data subject requests deletion (GDPR Art. 17)
2. Locate off-chain content via on-chain hash
3. Delete PII from off-chain store
4. Destroy encryption key (if CRAB encryption used)
5. On-chain hash becomes orphaned (points to nothing)
6. Audit log key destruction event
7. Confirm deletion to data subject
```

Include key destruction requirements:
- HSM-based key management recommended
- Key destruction must be auditable
- Backup key copies must also be destroyed
- Time limit: 30 days from valid request
  </action>
  <verify>
File exists at `specifications/architecture/HYBRID-ARCHITECTURE.md`.
File contains "Data Classification Matrix" section.
File contains "EDPB Guidelines 02/2025" reference.
File contains "CRAB Model" section.
File contains explicit prohibition of encrypted/hashed PII on-chain.
  </verify>
  <done>
Data classification matrix distinguishes on-chain (immutable references) from off-chain (erasable content). EDPB compliance checklist provides implementation verification. CRAB model enables right-to-erasure.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Event Sourcing Protocol and Component Diagrams</name>
  <files>specifications/architecture/HYBRID-ARCHITECTURE.md</files>
  <action>
Append to `specifications/architecture/HYBRID-ARCHITECTURE.md`:

## 5. Event Sourcing Protocol

Document the sync pattern between on-chain and off-chain:

### 5.1 Source of Truth Hierarchy
```
OWNERSHIP & ATTESTATION: On-chain is authoritative
- Token ownership (who owns the product)
- Compliance attestation results (pass/fail)
- Timestamp of events

CONTENT & PII: Off-chain is authoritative
- Full product details (DPP content)
- Personal information (customer, artisan)
- Document attachments (certificates, images)

CONFLICT RESOLUTION:
- Ownership disputes: On-chain wins (blockchain finality)
- Content disputes: Off-chain wins (latest version)
- Hash mismatch: Flag for reconciliation, do not auto-resolve
```

### 5.2 Event Flow Protocol

```
Product Lifecycle Event Flow:

1. ACTION OCCURS
   - Product created, transferred, serviced, or decommissioned

2. OFF-CHAIN FIRST
   - Store complete event details in off-chain store
   - Generate unique off-chain content ID
   - Include all PII and documents

3. COMPUTE HASH
   - SHA-256 hash of canonical JSON representation
   - Include version field for schema evolution
   - Hash algorithm ID in metadata for crypto-agility

4. ON-CHAIN EVENT
   - Emit event with: productDID, eventType, contentHash, timestamp
   - No PII ever touches blockchain
   - Emitter address recorded automatically

5. INDEX UPDATE
   - Off-chain indexer links contentHash -> offChainId
   - Enable forward lookup (hash to content)
   - Enable reverse lookup (product to events)

6. VERIFICATION
   - Re-hash off-chain content
   - Compare with on-chain hash
   - Flag discrepancies for investigation
```

### 5.3 Failure Handling

Document recovery procedures:
- **Off-chain write fails**: Retry with exponential backoff, do NOT emit on-chain event until confirmed
- **On-chain write fails**: Content exists off-chain, retry on-chain emission, no data loss
- **Hash mismatch detected**: Quarantine record, investigate, manual resolution required
- **Indexer lag**: Graceful degradation, on-chain events always available, off-chain eventual consistency

## 6. Component Interaction Diagrams

Create ASCII diagrams showing system interactions:

### 6.1 Core Components

```
+-------------------+     +-------------------+     +-------------------+
|                   |     |                   |     |                   |
|  Product Token    |<--->|  Identity         |<--->|  Compliance       |
|  (ERC-3643)       |     |  Registry         |     |  Module           |
|                   |     |  (ONCHAINID)      |     |                   |
+-------------------+     +-------------------+     +-------------------+
        |                         |                         |
        |    ON-CHAIN BOUNDARY    |                         |
========|=========================|=========================|========
        |    OFF-CHAIN BOUNDARY   |                         |
        v                         v                         v
+-------------------+     +-------------------+     +-------------------+
|                   |     |                   |     |                   |
|  DPP Content      |     |  Claim Storage    |     |  Compliance       |
|  Store            |     |  (VCs)            |     |  Evidence         |
|                   |     |                   |     |                   |
+-------------------+     +-------------------+     +-------------------+
```

### 6.2 Resolution Flow

```
Consumer Scan Flow:

[Physical Product] --scan--> [GS1 Digital Link]
                                    |
                                    v
                            [GS1 Resolver]
                                    |
                            (context detection)
                                    |
                    +---------------+---------------+
                    |               |               |
                    v               v               v
            [Consumer View]  [Brand View]   [Regulator View]
            (public DPP)    (full history)  (compliance data)
```

### 6.3 Transfer Flow

```
Ownership Transfer Flow:

1. Buyer Identity  ---verify---> [Identity Registry]
                                        |
                                   (claims check)
                                        |
2. Compliance Check <---result--- [Compliance Module]
                                        |
                                   (if compliant)
                                        |
3. Token Transfer  ---execute---> [Product Token]
                                        |
4. Off-Chain Update <---event--- [Event Listener]
                                        |
5. DPP Updated     <---write--- [Off-Chain Store]
```

## 7. Implementation Notes

Add guidance for implementers:

### 7.1 Off-Chain Storage Requirements
- Must support GDPR deletion within 30 days
- Must maintain audit trail of deletions
- Recommended: IPFS with garbage collection OR traditional database with TTL
- NOT recommended: IPFS without pinning control (immutable by default)

### 7.2 Hash Algorithm Selection
- Current: SHA-256 (widely supported)
- Future: SHA-3 or BLAKE3 (crypto-agility path)
- Always include algorithm ID in metadata

### 7.3 Indexer Requirements
- Eventually consistent is acceptable
- Must handle chain reorganizations
- Must support point-in-time queries
- Recommended: Event sourcing database (e.g., EventStoreDB)
  </action>
  <verify>
File contains "Event Sourcing Protocol" section.
File contains "Source of Truth Hierarchy" definition.
File contains "Component Interaction Diagrams" section.
File contains ASCII diagrams for core components and flows.
File contains "Implementation Notes" section.
  </verify>
  <done>
Event sourcing protocol defines how on-chain events synchronize with off-chain content. Component diagrams show GS1 Resolver, Identity Registry, and Token Contract interactions. Implementation notes provide practical guidance.
  </done>
</task>

</tasks>

<verification>
1. File exists at `specifications/architecture/HYBRID-ARCHITECTURE.md`
2. Data Classification Matrix clearly separates on-chain (references) from off-chain (content)
3. EDPB 02/2025 compliance checklist is complete and actionable
4. CRAB model for erasure is documented with key destruction flow
5. Event sourcing protocol defines source-of-truth hierarchy
6. Component diagrams show system architecture
7. Implementation notes provide practical guidance
</verification>

<success_criteria>
- FOUND-01 requirement satisfied: Hybrid architecture document complete
- Implementer can determine exactly what data goes where
- GDPR compliance path is clear (no personal data on-chain)
- Event sourcing pattern enables hybrid sync
- Architecture is ready to support Phase 3 (Data Models) and Phase 4 (Identity)
</success_criteria>

<output>
After completion, create `.planning/phases/02-architecture-foundation/02-01-SUMMARY.md`
</output>
